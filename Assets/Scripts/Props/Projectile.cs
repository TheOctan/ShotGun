using OctanGames.Entities;
using System.Collections;
using System.Collections.Generic;
using UnityEngine;

namespace OctanGames.Props
{
	public class Projectile : MonoBehaviour
	{
		public LayerMask collisionMask;
		public Color trailColor;
		private float speed = 10f;
		private float damage = 1f;

		private float lifeTime = 3;
		private float skinWidth = 0.1f;

		void Start()
		{
			Destroy(gameObject, lifeTime);

			Collider[] initialCollisions = Physics.OverlapSphere(transform.position, 0.1f, collisionMask);
			if (initialCollisions.Length > 0)
			{
				OnHitObject(initialCollisions[0], transform.position);
			}

			GetComponent<TrailRenderer>().material.SetColor("_TintColor", trailColor);
		}

		public void SetSpeed(float speed)
		{
			this.speed = speed;
		}

		void Update()
		{
			float moveDistance = speed * Time.deltaTime;
			CheckCollisions(moveDistance);
			transform.Translate(Vector3.forward * moveDistance);
		}

		void CheckCollisions(float moveDistance)
		{
			Ray ray = new Ray(transform.position, transform.forward);
			RaycastHit hit;
			//Debug.DrawLine(transform.position, transform.position + transform.forward, Color.red);

			if (Physics.Raycast(ray, out hit, moveDistance + skinWidth, collisionMask, QueryTriggerInteraction.Collide))
			{
				OnHitObject(hit.collider, hit.point);
			}
		}

		void OnHitObject(Collider c, Vector3 hitPoint)
		{
			IDamageable damageableObject = c.GetComponent<IDamageable>();
			if (damageableObject != null)
			{
				damageableObject.TakeHit(damage, hitPoint, transform.forward);
			}
			Destroy(gameObject);
		}
	}
}